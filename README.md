# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом
- src/components/models — папка с моделями данных
- src/components/views — папка с классами, отвечающими за отображение данных
- src/presenters — папка с классами, реализующими Presenter

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/ — папка с типами
- src/index.ts — точка входа приложения, реализация класса App
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами


## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```


## Архитектура проекта
Приложение построено по MVP-архитектуре (событийно-ориентированная, с помощью брокера событий - EventEmitter).

### Model - классы, отвечающие за модель данных
- Model (базовый класс)
- CatalogModel
- BasketModel
- OrderModel

### View - классы, отвечающие за отображение данных
- View (базовый класс)
- HeaderView
- PageView
- ProductView
- SuccessView
- ModalView
- FormView
- DeliveryFormView
- ContactsFormView
- BasketView
- ProductInBasketView

### Presenter - классы, обеспечивающие связь между Model и View
- BasketPresenter
- CatalogPresenter
- ModalPresenter
- OrderPresenter
- PostOrderPresenter


## Базовые классы

### Api
Api - класс, обеспечивающий работу с API. 

Он позволяет:
- отправлять GET-запросы к серверу
- отправлять POST, DELETE-запросы к серверу
- обрабатывать ответы от сервера

### EventEmitter
EventEmitter - это класс, который позволяет обмениваться событиями между
разными частями приложения. Он обеспечивает разделение между компонентами,
которые отправляют события, и компонентами, которые их получают, 
разрешая компонентам не знать о существовании друг друга.

EventEmitter - это классическая реализация брокера событий. 
Он обеспечивает три основных метода: `on()` - для регистрации обработчика,
`emit()` - для отправки события, `off()` - для снятия обработчика.

### View
Класс View - это базовый класс для всех классов отображения. Он инициализирует контейнер, в котором будут отображаться данные, и обеспечивает доступ к объекту событий, который может использоваться для отправки событий.

Класс View имеет следующие методы:
- `toggleClass(className: string, condition: boolean)`: добавляет или удаляет CSS-класс
- `setText(value: unknown)`: устанавливает текстовое содержимое элемента
- `setImage(src: string, alt?: string)`: устанавливает изображение
- `setActivity(condition: boolean)`: блокирует или разблокирует элемент
- `render(data?: Partial<T>)`: возвращает HTML-контейнер, используя данные для заполнения

### Model
Абстрактный класс `Model` предназначен для управления данными и событиями в приложении. Класс обеспечивает базовую функциональность для работы с данными и событиями, предоставляя методы для инициации событий и обновления данных модели.
@template T - тип данных, который будет использоваться моделью.

Свойства:
- `_data` (protected): хранит текущие данные модели.
- `_events` (protected): объект для управления событиями.

Конструктор:
- принимает начальные данные и объект событий, которые сохраняются в соответствующих свойствах.

Методы:
- `emitEvent` (protected): инициирует событие с переданным именем и данными.
- `updateData` (protected): обновляет данные модели с использованием функции обновления.
- `data` (getter): возвращает текущие данные модели.


## Типы данных
### IBasketItem
```typescript
/**
 * Интерфейс для представления элемента корзины
 *
 * @property {string} id - уникальный идентификатор товара
 * @property {string} title - наименование товара
 * @property {number} price - цена товара
 */
export interface IBasketItem extends Pick<IProduct, 'id' | 'title' | 'price'> {};
```

### IBasketModel
```typescript
/**
 * Интерфейс для модели корзины
 *
 * @method addItem - добавляет элемент в корзину
 * @param {IBasketItem} item - элемент корзины
 * @method removeItem - удаляет элемент из корзины
 * @param {string} id - уникальный идентификатор элемента корзины
 * @property {number} total - общая сумма корзины
 * @method clear - очищает корзину
 */
export interface IBasketModel {
    addItem(item: IBasketItem): void;
    removeItem(id: string): void;
    getLength(): number;
    clear(): void;
    get total(): number;
};
```

### Events
```typescript
/**
 * Типы событий
 */
export enum Events {
    CATALOG_LOADED = 'catalog:loaded', // Каталог товаров загружен

    PRODUCT_ADDED = 'product:added', // Товар добавлен в корзину
    PRODUCT_REMOVED = 'product:removed', // Товар удалён из корзины
    PRODUCT_PREVIEW = 'product:preview', // Просмотр карточки товара
    PRODUCT_DATA_LOADED = 'product:data-loaded', // Данные товара загружены

    BASKET_OPEN = 'basket:open', // Открытие модалки корзины
    BASKET_UPDATE = 'basket:update', // Изменение состава корзины
    BASKET_CLEAR = 'basket:clear', // Корзина очищена

    ORDER_PAYMENT_CHANGE = 'order:payment-change', // Изменение способа оплаты
    ORDER_ADDRESS_CHANGE = 'order:address-change', // Изменение адреса доставки
    CONTACTS_EMAIL_CHANGE = 'contacts:email-change', // Изменение email
    CONTACTS_PHONE_CHANGE = 'contacts:phone-change', // Изменение телефона

    ORDER_DELIVERY_FORM_VALID = 'order:delivery-form-valid', // Форма доставки валидна
    ORDER_DELIVERY_FORM_OPEN = 'order:order-form-open', // Форма доставки открыта
    ORDER_CONTACTS_FORM_VALID = 'order:contacts-form-valid', // Форма контактов валидна
    ORDER_CONTACTS_FORM_OPEN = 'order:contacts-form-open', // Форма контактов открыта
    ORDER_DELIVERY_FORM_SUBMIT = 'order:order-form-submit', // Отправка данных доставки
    ORDER_CONTACTS_FORM_SUBMIT = 'order:contacts-form-submit', // Отправка данных контактов
    
    MODAL_OPEN = 'modal:open', // Открытие любого модального окна
    MODAL_CLOSE = 'modal:close', // Закрытие любого модального окна

    ORDER_SUCCESS = 'order:success', // Заказ оформлен
    ORDER_RESET  = 'order:reset', // Сброс состояния заказа

    DELIVERY_FORM_ERROR = 'delivery-form:error', // Ошибка валидации формы доставки
    CONTACTS_FORM_ERROR = 'contacts-form:error', // Ошибка валидации формы доставки
    API_ERROR = 'api:error' // Ошибка взаимодействия с API
};
```

### PaymentMethod
```typescript
/**
 * Тип способа оплаты
 */
export type PaymentMethod = 'card' | 'cash';
```

### IOrderData
```typescript
/**
 * Интерфейс для представления данных заказа
 *
 * @property {PaymentMethod} payment - способ оплаты
 * @property {string} address - адрес доставки
 * @property {string} email - электронная почта
 * @property {string} phone - номер телефона
 */
export interface IOrderData {
    payment: PaymentMethod | null;
    address: string;
    email: string;
    phone: string;
}
```

### IOrderFullData
```typescript
/**
 * Интерфейс для представления полных данных заказа
 *
 * @property {string[]} items - массив id товаров
 * @property {number} total - общая стоимость заказа
 */
export interface IOrderFullData extends IOrderData {
    items: string[];
    total: number;
}
```

### FormErrors
```typescript
/**
 * Тип для ошибок валидации полей формы заказа
 *
 * @property {string} payment - ошибка валидации способа оплаты
 * @property {string} address - ошибка валидации адреса доставки
 * @property {string} email - ошибка валидации электронной почты
 * @property {string} phone - ошибка валидации номера телефона
 */
export type FormErrors = {
    [K in keyof IOrderData]: K extends 'payment' ? string : string;
};
```

### IOrderModel
```typescript
/**
 * Интерфейс для модели заказа
 *
 * @method validatePayment - проверяет валидность способа оплаты
 * @method validateAddress - проверяет валидность адреса доставки
 * @method validateEmail - проверяет валидность электронной почты
 * @method validatePhone - проверяет валидность номера телефона
 * @method validateDeliveryForm - проверяет валидность формы доставки
 * @method validateContactsForm - проверяет валидность формы контактов
 * @method reset - сбрасывает данные форм
 */
export interface IOrderModel {
    validatePayment(): boolean;
    validateAddress(): boolean;
    validateEmail(): boolean;
    validatePhone(): boolean;
    validateDeliveryForm(): void;
    validateContactsForm(): void;
    reset(): void;
};
```

### Category
```typescript
/**
 * Тип категории товара
 */
type Category = 
    | 'софт-скил'
    | 'хард-скил'
    | 'другое'
    | 'дополнительное'
    | 'кнопка';
```

### IProduct
```typescript
/**
 * Интерфейс для представления товара
 *
 * @property {string} id - уникальный идентификатор товара
 * @property {Category} category - категория товара
 * @property {string} title - наименование товара
 * @property {string} description - описание товара
 * @property {string} image - URL изображения товара
 * @property {number} price - цена товара
 * @property {boolean} inBasket - флаг добавления товара в корзину
 */
interface IProduct {
    id: string;
    category: Category;
    title: string;
    description: string;
    image: string;
    price: number;
}
```

### ICatalogModel
```typescript
/**
 * Интерфейс для модели списка товаров
 *
 * @method loadProducts - загрузить список товаров
 * @returns {Promise<void>} - промис, который разрешается после загрузки списка товаров
 */
export interface ICatalogModel {
    loadProducts(): Promise<void>;
}
```


## Модели данных
Модели данных - классы, содержащие данные, которые нужно отобразить на странице.

### 1. CatalogModel
ProductModel - это класс, который работает с API каталога. Он обеспечивает загрузку товаров с API, а также хранит информацию о них.

### 2. BasketModel
BasketModel - это класс, который хранит информацию о товарах, добавленных в корзину. Он обеспечивает добавление и удаление товаров из корзины, а также хранит общую сумму заказа.

### 3. OrderModel
OrderModel - класс, который отвечает за хранение и управление данными заказа. Он предоставляет методы для обновления полей данных заказа и их валидации.


## Отображение данных
Классы, которые отвечают за отображение данных на странице.

### 1. HeaderView
HeaderView - это класс, отвечающий за отображение и управление элементами заголовка страницы, такими как корзина. Он наследуется от базового класса View и реализует интерфейс IHeaderView. В классе используются приватные свойства `_basketCounter` и `_basketButton`, которые представляют собой HTML-элементы, отображающие количество товаров в корзине и кнопку корзины соответственно. Конструктор класса принимает контейнер и объект событий, инициализирует элементы заголовка и добавляет обработчик события клика по кнопке корзины, который вызывает событие открытия корзины. Метод `set counter` используется для обновления текстового содержимого счетчика корзины.

### 2. PageView
Класс PageView - это класс, который отвечает за отображение католога товаров на странице. Он наследуется от базового класса View и реализует интерфейс IPageView. В классе используется приватное свойство `_gallery`, которое хранит HTML-элемент, в который будут отображены элементы страницы. Конструктор класса принимает контейнер и объект событий, инициализирует HTML-элемент галереи и добавляет обработчики событий. Метод `set gallery` используется для обновления содержимого галереи.

### 3. ProductView
Класс `ProductView` отвечает за отображение информации о продукте на веб-странице. Он наследуется от базового класса `View`, обеспечивая взаимодействие с HTML-элементами, представляющими данные продукта, такие как название, описание, цена, изображение, категория и кнопка действия. В конструкторе класса инициализируются HTML-элементы, которые будут использованы для отображения соответствующих данных.
Таким образом, `ProductView` обеспечивает инкапсуляцию логики отображения продуктов на странице, позволяя динамически обновлять интерфейс в ответ на изменения данных.

### 4. SuccessView
Класс SuccessView - это класс, который отвечает за отображение модального окна со ссылкой на успешную покупку. Он наследуется от базового класса View. В конструкторе класса инициализируются HTML-элементы модального окна, а также добавляется обработчик события на кнопку закрытия модального окна.

### 5. ModalView
Класс ModalView - это класс, который отвечает за отображение модального окна на странице. Он наследуется от базового класса View и реализует интерфейс IModalView. Класс обеспечивает отображение модального окна, а также добавляет обработчики событий.

### 6. FormView
Класс `FormView` - это абстрактный класс, который предназначен для отображения формы на странице. Он наследуется от базового класса `View` и реализует интерфейс `IFormView`. Класс обеспечивает отображение формы, а также добавляет обработчики событий для полей ввода и
обработки событий отправки формы. Метод `render` позволяет установить значения полей формы, а также отобразить ошибки валидации.

### 7. DeliveryFormView
Класс DeliveryFormView - это класс, который обеспечивает отображение формы доставки на странице. Он наследуется от абстрактного класса FormView и реализует интерфейс IDeliveryForm. Класс добавляет обработчики событий для кнопок выбора способа оплаты и отправки формы. Метод `render` позволяет установить значения полей формы, а также отобразить ошибки валидации.

### 8. ContactsFormView
Класс ContactsFormView - это класс, который обеспечивает отображение формы контактов на странице. Он наследуется от абстрактного класса FormView и реализует интерфейс IContactsForm. Класс добавляет обработчики событий для кнопок отправки формы. Метод `render` позволяет установить значения полей формы, а также отобразить ошибки валидации.

### 9. BasketView
Класс `BasketView` отвечает за отображение корзины на странице. Он наследуется от базового класса `View` и реализует интерфейс `IBasketView`. Этот класс обеспечивает управление отображением списка продуктов в корзине, общей суммы и кнопки для перехода к оформлению заказа.
Класс `BasketView` обеспечивает динамическое обновление элементов отображения корзины и позволяет пользователю взаимодействовать с интерфейсом для перехода к следующему шагу в процессе оформления заказа.

### 10. ProductInBasketView
Класс `ProductInBasketView` - это класс, который обеспечивает отображение элементов корзины на странице. Он наследуется от базового класса `View` и реализует интерфейс `IProductInBasketView`. Класс `ProductInBasketView` обеспечивает динамическое обновление элементов отображения элемента корзины, включая порядковый номер, наименование, цену и кнопку для удаления элемента.


## Презентеры
### 1. BasketPresenter
#### Назначение:
Управляет отображением корзины товаров, синхронизирует данные модели (`BasketModel`) с представлениями (`BasketView`, `HeaderView`), обрабатывает события добавления/удаления товаров.
#### Основные функции:
##### Подписка на события:
- Реагирует на обновление корзины (`BASKET_UPDATE`).
- Удаляет товар при событии `PRODUCT_REMOVED`.
##### Обновление корзины (`changeBasket`):
- Обновляет счетчик товаров в шапке (HeaderView).
- Рендерит список товаров через ProductInBasketView.
- Отображает итоговую сумму.
##### Удаление товара (`removeProduct`):
- Удаляет товар из модели (BasketModel).
- Открывает корзину после удаления (BASKET_OPEN).
#### Зависимости:
- `EventEmitter` — обработка событий.
- `BasketModel` — хранение данных корзины.
- `BasketView`, `HeaderView` — отображение состояния.
- `ProductInBasketView` — рендер карточки товара в корзине.

### 2. CatalogPresenter
#### Назначение:
Управляет отображением каталога товаров, синхронизирует данные модели (`CatalogModel`) с представлением (`PageView`), обрабатывает события загрузки и отображения товаров.
#### Основные функции:
##### Подписка на события:
- Реагирует на загрузку каталога (`CATALOG_LOADED`).
##### Загрузка каталога (`loadCatalog`):
- Получает данные товаров из модели (`CatalogModel`).
- Создает карточки товаров (`ProductView`) на основе шаблона.
- Обновляет галерею товаров в `PageView`.
#### Зависимости:
- `EventEmitter` — обработка событий.
- `CatalogModel` — хранение данных каталога.
- `PageView` — представление страницы с галереей товаров.
- `ProductView` — рендер карточки товара.
#### События:
- `CATALOG_LOADED` — после загрузки данных каталога.
- `PRODUCT_PREVIEW` — при клике на карточку товара.

### 3. ModalPresenter
#### Назначение:
Управляет модальными окнами приложения, включая превью товаров, корзину и формы оформления заказа. Связывает модели (`BasketModel`, `OrderModel`) с представлениями (`ModalView`, `BasketView`, `DeliveryFormView`, `ContactsFormView`), обрабатывает пользовательские действия через события.
#### Основные функции:
##### Подписка на события:
- `BASKET_OPEN` – открывает корзину.
- `PRODUCT_PREVIEW` – показывает превью товара.
- `MODAL_OPEN/MODAL_CLOSE` – управляет видимостью модального окна.
- `ORDER_DELIVERY_FORM_OPEN` – открывает форму доставки.
- `ORDER_DELIVERY_FORM_SUBMIT` – переключает на форму контактов.
##### Открытие корзины (`openBasket`):
- Рендерит содержимое корзины (`BasketView`).
- Проверяет наличие товаров перед отображением.
##### Превью товара (`showProductPreview`):
- Создает карточку товара (`ProductView`) с возможностью добавления/удаления из корзины.
- Обновляет текст кнопки ("В корзину"/"Удалить") в зависимости от состояния.
##### Управление модальным окном (`changeModal`):
- Блокирует/разблокирует страницу (`PageView`) при открытии/закрытии модалки.
##### Рендер форм (`renderForm`):
- Отображает форму доставки или контактов на основе переданного типа.
- Подгружает сохраненные данные из OrderModel.
#### Зависимости:
- `EventEmitter` – обработка событий.
- `BasketModel` – данные корзины.
- `OrderModel` – данные заказа.
- `ModalView` – базовое модальное окно.
- `BasketView` – содержимое корзины.
- `DeliveryFormView` / `ContactsFormView` – формы оформления.
- `ProductView` – карточка товара.
#### События:
- Все события из `Events` (импортированные).
- Генерирует события при взаимодействии с товарами (`PRODUCT_PREVIEW`).

### 4. OrderPresenter
#### Назначение:
Управляет процессом оформления заказа, включая валидацию и обработку данных форм доставки и контактов. Связывает модель заказа (`OrderModel`) с представлениями форм (`DeliveryFormView`, `ContactsFormView`), обрабатывает изменения полей и ошибки валидации.
#### Основные функции:
##### Подписка на события:
Обрабатывает 3 группы событий через регулярные выражения:
###### 1. Изменение данных заказа (`order|contacts:*-change`):
- `order:payment-change` – выбор способа оплаты.
- `order:address-change` – ввод адреса доставки.
- `contacts:email-change` / `contacts:phone-change` – изменение контактных данных.
###### 2. Ошибки валидации (`delivery|contacts-form:error`):
- `DELIVERY_FORM_ERROR` – ошибки в форме доставки.
- `CONTACTS_FORM_ERROR` – ошибки в форме контактов.
###### 3. Успешная валидация (`order:*-form-valid`):
- `ORDER_DELIVERY_FORM_VALID` – форма доставки корректна.
- `ORDER_CONTACTS_FORM_VALID` – форма контактов корректна.
##### Обработка данных (`changeOrder`):
- Обновляет данные в `OrderModel` (адрес, оплата, email, телефон).
- При изменении способа оплаты (`payment`) приводит значение к типу `PaymentMethod`.
##### Отображение ошибок (`changeErrors`):
- Показывает ошибки валидации для активной формы (доставка/контакты).
- Объединяет несколько ошибок в одну строку (через пробел).
##### Валидация формы (`formValid`):
- Сбрасывает ошибки и помечает форму как корректную.
#### Зависимости:
- `EventEmitter` – обработка событий.
- `OrderModel` – хранение данных заказа.
- `DeliveryFormView` – форма доставки.
- `ContactsFormView` – форма контактов.

### 5. PostOrderPresenter
#### Назначение:
Отвечает за отправку данных заказа на сервер и обработку результата. После успешного оформления заказа очищает корзину (`BasketModel`) и сбрасывает данные заказа (`OrderModel`), а также отображает модальное окно с подтверждением.
#### Основные функции:
##### Подписка на события:
- Реагирует на отправку формы контактов (`ORDER_CONTACTS_FORM_SUBMIT`).
##### Отправка заказа (`postOrder`):
###### 1. Формирует данные заказа:
- Список ID товаров из корзины (`items`).
- Общую сумму (`total`).
- Данные из `OrderModel` (способ оплаты, адрес, email, телефон).
###### 2. Отправляет запрос на сервер:
- Использует метод post `API` (/order).
###### 3. Обрабатывает успешный ответ:
- Отображает модальное окно с подтверждением (`SuccesView`).
- Очищает корзину (`BasketModel`.clear()).
- Сбрасывает данные заказа (`OrderModel`.reset()).
#### Зависимости:
- `EventEmitter` – обработка событий.
- `BasketModel` – данные корзины.
- `OrderModel` – данные заказа.
- `ModalView` – модальное окно.
- `Api` – взаимодействие с сервером.
- `SuccesView` – представление успешного оформления заказа.

## Интеграция
В файле index.ts создается экземпляр класса App, который инициализирует приложение.
### Назначение:
Главный класс приложения, который инициализирует все компоненты системы (модели, представления, презентеры) и связывает их между собой. Выступает точкой входа в приложение.
### Структура:
#### Основные компоненты (core):
- `EventEmitter`
- `Api`
#### Модели (models):
- `BasketModel`
- `CatalogModel`
- `OrderModel`
#### Представления (views):
- `HeaderView`
- `PageView`
- `ModalView`
- `BasketView`
- `DeliveryFormView` 
- `ContactsFormView`
#### Презентеры (presenters):
- `ModalPresenter`
- `CatalogPresenter`
- `BasketPresenter`
- `OrderPresenter`
- `PostOrderPresenter`